<!DOCTYPE html>
<html>
<!-- For OAuth google authentication. -->
<script type="text/javascript" src="/js/chrome_ex_oauthsimple.js"></script>
<script type="text/javascript" src="/js/chrome_ex_oauth.js"></script>

<!-- For importing to google contacts. -->
<script type="text/javascript" src="/js/gmail-contacts.js"></script>
<script type="text/javascript" src="/js/csv-contacts.js"></script>

<!-- Add additional export/import methods here. -->
<script type="text/javascript" src="/js/jquery-1.4.2.min.js"></script>
<script type="text/javascript">

var facebook_id = -1;
var worker_id = -1;

/**
* Open a singleton page, which means, if a page already exists, it just selects it.
* @param url The page which it will navigate to.
*/
function openSingletonPage(url) {
  var views = chrome.extension.getViews();
  for (var v in views) {
    var view = views[v];
    if (view.location.href.indexOf(url) == 0) {
      view.focus();
      return;
    }
  }
  chrome.tabs.create({url: url}, function(tab) {
    worker_id = tab.id;
  });
}

// Extension request listener.
chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if (request.switchToWorkerTab) {
    facebook_id = sender.tab.id;
    console.log('switchToWorkerTab');
    openSingletonPage(chrome.extension.getURL('start.html'));
  }
  else if (request.relayInfoForFriend) {
    console.log('relayInfoForFriend');
    chrome.tabs.sendRequest(worker_id, {
        gotInfoForFriend: request.relayInfoForFriend
    });
  }
  else if (request.doGmailExport) {
    google_StartExportWithFriends(request.requestedFriends);
  }
  else if (request.doCSVExport) {
    var csv_text = csv_DoExport(request.requestedFriends);
    chrome.tabs.sendRequest(worker_id, { csvExportFinished: csv_text });
  }
  
});
</script>
</html>
